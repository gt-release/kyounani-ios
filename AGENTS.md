# AGENTS.md

このドキュメントは、`kyounani-ios` の目標設計に対して、現時点実装がどこまで対応しているかを整理したものです。

## 開発運用ルール（最重要）
- **実装変更とドキュメント更新は必ずセットで行うこと。**
  - 最低でも `README.md` と本 `AGENTS.md` の該当箇所を同一PRで更新する。
  - フェーズ計画に影響する場合は、`PHASE1-PLAN.md` など関連計画書も更新する。
- PR作成は **commit -> push -> create PR** の順で行う。
  - GitHubアプリで400系エラーが出る場合、head未push / base-head同一 / 既存PR重複を最初に確認する。

## 実行環境前提（追記）
- 開発・検証の実行入口は **iPadのSwift Playgroundsで開ける `.swiftpm`（App project）** を優先する。
- **Mac / Xcode / xcodebuild 前提の手順は採用しない**（このリポジトリでは検証手順にも含めない）。

## 1. 目的への対応状況
- 子どもが当日の予定を自力で把握できる導線: **対応強化（部分対応）**
  - Todayホーム（今日/次/先の予定チラ見せ）を実装。
  - Todayホームからカレンダー（月/週）へ遷移可能。
  - ただしスタンプ画像中心UIや導線の見た目最適化は未完成。
- 先の予定の見通しで「がっかり」を減らす: **部分対応（前進）**
  - 月表示/週表示の見通しUIを追加。
  - 日別詳細へのドリルダウンを追加。
- 開始までの待ち時間可視化: **対応済み（最小）**
  - 残り時間リング（複数時間時の多層）と分表示を実装。

## 2. 技術方針への対応
- iPad / SwiftUI: **対応済み（最小）**
  - SwiftUI画面に加えて、`Kyounani.swiftpm`（iPad Swift Playgrounds向けApp project）を追加。
  - 既存Swift Packageをローカル参照し、起動直後にTodayホームへ接続。
- 永続化Repository分離: **部分対応**
  - Repository抽象とInMemory実装あり。
  - SwiftData実装は未着手。
- ネットワーク不要: **対応済み**
- 通知なし: **対応済み**

## 3. モード・権限制御
- 起動時は子ども用モード: **対応済み**
- 子ども用フィルタ（息子/娘/両方）: **対応済み**
- ペアレンタルゲート（3本指2秒長押し起点）: **部分対応**
  - 4点シーケンスタップ、失敗時クールダウン、緊急4桁コードは実装。
  - 「3本指2秒長押し」ジェスチャー起点は未実装。
- Face ID/Touch ID未使用: **対応済み**

## 4. 情報設計（visibility）
- `published/draft` モデル: **対応済み**
- 子どもモードでpublishedのみ表示: **対応済み**
- 変更影響マーク: **未対応（任意機能）**

## 5. 画面構成
- Todayホーム: **部分対応**
  - 今日最大2件＋`+N`、次カード、先の予定チラ見せを実装。
  - カレンダーへの遷移ボタンを追加。
- 月/週カレンダー（見通し）: **対応済み（最小）**
  - 月表示/週表示の切替、日曜始まり、祝日/土日色分け、日セル2件+`+N` を実装。
- 日別詳細 + TimerOverlay: **部分対応**
  - 日別詳細一覧を追加。
  - 予定タップで既存TTS + TimerRing表示へ接続。
- 親モードCRUD/繰り返し例外UI/スタンプ管理/テンプレ: **部分対応**
  - 簡易一覧・削除・クイック追加のみ。
  - 本格CRUD、例外編集3択UI、スタンプ管理は未実装。

## 6. 祝日（日本オフライン）
- CSV同梱 + `JapaneseHolidayService`: **対応済み（最小）**
- 祝日表示（赤など）: **対応済み（最小）**
  - カレンダー日付の文字色/背景色で表現。
- 繰り返しの祝日スキップ: **対応済み**

## 7. 予定仕様
- イベント主要属性: **部分対応**
  - 多くの属性はモデル化済み。
  - 一部UI・保存フローへの接続は未完。
- 繰り返し（週次）: **対応済み**
- 例外（override/delete/splitFromThisDate）: **対応済み（エンジン）**
- 例外編集UI（この日だけ/以降/全体）: **未対応**

## 8. 子ども向けタップ挙動
- 日本語TTS（enhanced優先）: **対応済み**
- リング更新（分単位で進む体感）: **対応済み（1秒更新）**
- 開始済み表示: **対応済み**

## 9. スタンプ
- 初期スタンプセット同梱: **対応済み（Phase 3 最小 / JSON+SF Symbols）**
  - `Kyounani.swiftpm` と `KyounaniApp` の両Resourcesに `builtin_stamps.json` を配置。
  - 旧 `builtin:<name>` 形式との互換表示を保持。
- ユーザー追加（Files/Photos→トリミング→保存）: **対応済み（最小）**
- カレンダートークンの差し替えポイント: **対応済み（Phase 3適用）**
  - `EventTokenRenderer` に描画責務を集約。

## 10. 保存/バックアップ
- iCloud同期なし: **対応済み（未実装）**
- 暗号化エクスポート: **未対応**

## 11. アーキテクチャ
- MVVM: **対応済み（最小構成）**
- カレンダー日次集約（最大2件+N）の共通化: **対応済み（ViewModel/Presenter）**
- Repository分離: **対応済み（抽象＋InMemory）**
- `JapaneseHolidayService` / `RecurrenceEngine`: **対応済み**
- 日本タイムゾーン前提: **対応済み**

## 12. テスト
- `JapaneseHolidayService` 単体テスト: **対応済み**
- `RecurrenceEngine` 単体テスト（週次/祝日スキップ/override-delete/以降変更）: **対応済み**

## 13. 受け入れ条件への現状判定
- 子どもモードで編集不可: **部分対応**（親モード解錠が必要）
- 起動直後Todayホーム: **対応済み**
- 月/週でスタンプ表示: **対応済み（スタンプ画像中心）**
- タップで日本語読み上げ: **対応済み**
- タップでリング進行 + 複数リング: **対応済み**
- 週次繰り返し + 祝日スキップ + 単発例外: **対応済み（ドメイン）**
- 祝日表示: **対応済み（最小）**
- スタンプユーザー追加: **対応済み（最小）**

## 14. 次の優先実装（推奨）
1. 日別詳細からの例外編集3択UI（この日だけ/以降/全体）。
2. イベント永続化（SwiftData Repository実装と移行）。
3. カレンダーUI改善（スタンプ画像化、アクセシビリティ、見た目最適化）。
4. CI上でのSwift Package検証拡充（`swift test` / Playgrounds実行前提チェック）。
