# CODE REVIEW

## このPRで直したもの / 直していないもの
- **このPRで直したもの（低リスク）**
  - スタンプ画像ファイル名のサニタイズを追加し、`../` や不正文字を含むファイル名が保存パスに影響しないようにしました。
- **このPRでは直していないもの（提案のみ）**
  - バックアップ暗号化のKDF強化（PBKDF2/Argon2など）
  - Repositoryの永続化エラーをUIへ可視化する仕組み
  - 3本指長押しジェスチャの衝突回避（画面別無効化領域の精緻化）

## Critical

### 1) バックアップ鍵導出が `SHA256(passphrase+salt)` 固定
- **観点**: 暗号化バックアップ
- **現状**: AES-GCM自体は適切ですが、KDFが1回ハッシュで計算量が低く、総当たり耐性が弱いです。
- **リスク**: 弱いパスフレーズを使った場合にオフライン攻撃に弱い。
- **今PRで未対応の理由**: 既存バックアップ互換性と復元失敗リスクがあり、挙動変更の影響が大きいため。
- **対応案**:
  - `kdf` フィールドをバージョン化し、既存は復号のみ維持。
  - 新規エクスポートは PBKDF2-HMAC-SHA256（反復回数を端末性能に合わせ調整）へ移行。
  - 将来的にArgon2id対応を検討。

## High

### 2) 永続化エラーが黙殺されるため、データ消失に気づきにくい
- **観点**: 永続化、エラー時の落ち方
- **現状**: `try? context.save()` / `catch {}` で失敗が握りつぶされる箇所が複数あります。
- **リスク**: ユーザーは保存できたと誤認し、再起動後に消える。
- **今PRで未対応の理由**: UI通知設計（トースト/バナー/再試行）を伴い変更範囲が広い。
- **対応案**:
  - Repositoryに `lastError` など観測可能なエラー状態を追加。
  - 親モードのみでも保存失敗表示を実装。

### 3) 復元処理の「失敗時無変更」は設計上満たしているが、原子的更新の担保が弱い
- **観点**: 暗号化バックアップ復元時安全性
- **現状**: 復号/デコード失敗時は置換に到達しない構造。ただし置換は delete→insert の一括保存で、途中失敗時のロールバック戦略が明示されていません。
- **リスク**: 稀な保存失敗時に部分更新状態になる可能性。
- **今PRで未対応の理由**: SwiftDataのトランザクション制御導入は挙動確認が必要。
- **対応案**:
  - 可能なら明示トランザクションで `replaceAll` を実装。
  - 失敗時は復元前スナップショットを再投入するフェイルセーフを追加。

### 4) 3本指長押しは UI 衝突時の誤起動余地がある
- **観点**: 親ゲート
- **現状**: 右上固定領域で `cancelsTouchesInView = false` の長押し認識。
- **リスク**: 将来、右上に操作UIが増えた際に競合・誤作動が起きやすい。
- **今PRで未対応の理由**: 現状UIでは顕在化が限定的で、調整は実機でのUX確認が必要。
- **対応案**:
  - 親ゲート領域を `allowsHitTesting`/zIndex 設計込みで明示管理。
  - 親モード中は無効化など状態別制御を追加。

## Medium

### 5) Event/Exception不変条件の検証ロジックが薄い
- **観点**: データ整合性
- **現状**: `EventException.override` と `splitFromThisDate` の関連パラメータ整合（override必須など）をモデル境界で強制していません。
- **リスク**: 将来の入力経路追加で不正データ混入余地。
- **提案**: 保存前バリデーション関数をRepository層に導入。

### 6) フォールバック方針の実装と文書の粒度差
- **観点**: 永続化フォールバック
- **現状**: 実装は SwiftData失敗時に FileBacked。さらに InMemory までの自動フォールバックはコード上で明示的ではありません。
- **リスク**: 障害時の期待挙動が読み手に伝わりにくい。
- **提案**: `RepositoryFactory` に方針コメントとログを追加し、README/AGENTSと用語を揃える。

### 7) Swift Concurrency境界はMainActor寄りで安全だが、I/Oの同期実行が残る
- **観点**: Concurrency / パフォーマンス
- **現状**: `Data(contentsOf:)` やファイル書き込みがメインアクター上で走る箇所がある。
- **リスク**: 大きな画像やI/O遅延時にUI応答低下。
- **提案**: 画像処理とファイルI/Oを`Task.detached`等でオフロード（UI反映のみMainActor）。

### 8) 月/週表示の集約計算は機能的に問題ないが、キャッシュ戦略が弱い
- **観点**: パフォーマンス
- **現状**: 日次集約は共通化済み。表示範囲切替時の再計算が都度実行される。
- **リスク**: データ件数増加でスクロール体感悪化。
- **提案**: 範囲キー + filter/theme で軽量メモ化。

## Low

### 9) 命名・責務分離は概ね良好だが、同種のマイグレーション処理が分散
- **観点**: 可読性
- **現状**: legacy stamp 読み込みロジックが FileBacked と SwiftData の両方に存在。
- **リスク**: 仕様変更時の片修正。
- **提案**: 共有ユーティリティに抽出。

### 10) 日本タイムゾーン前提は明確だが、ドキュメント導線が分散
- **観点**: 可読性/運用
- **現状**: README・AGENTSに点在。
- **提案**: `docs/ARCHITECTURE.md` と `docs/QA_CHECKLIST.md` に集約リンク。

## 低リスク修正の実施内容（このPR）
- スタンプ画像保存時のファイル名をサニタイズし、パストラバーサルや不正文字混入に対して壊れにくくしました。
  - `suggestedFilename` から拡張子を除去
  - 英数字/`-`/`_` 以外を `_` に置換
  - 空文字や危険なケースは UUID にフォールバック
